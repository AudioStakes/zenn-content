---
title: "Playwright ã®ãƒ–ãƒ©ã‚¦ã‚¶éŒ²ç”»æ©Ÿèƒ½ã‚’ Ruby ã§å®Ÿè£…ã—ã¦ã¿ãŸ"
emoji: "ğŸ­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Ruby", "cdp", "javascript"]
published: false
---

## ã¯ã˜ã‚ã«

Node.js ã® E2E ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚‹ [Playwright](https://playwright.dev/) ã«ã¯[ãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œã‚’éŒ²ç”»ã™ã‚‹æ©Ÿèƒ½](https://playwright.dev/docs/videos#record-video)ãŒã‚ã‚Šã€ãã®æ©Ÿèƒ½ã«ã¯ [Chrome DevTools Protocol](https://chromedevtools.github.io/devtools-protocol/)ï¼ˆCDPï¼‰ãŒæ´»ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

ä¸€æ–¹ã€Ruby ã§å®Ÿè£…ã•ã‚ŒãŸãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹ [Ferrum](https://github.com/rubycdp/ferrum) ã‚‚åŒã˜ã CDP ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚‚ã®ã®ã€èª¿ã¹ãŸé™ã‚Šã§ã¯ Ferrum ã«ã¯ã¾ã éŒ²ç”»æ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚

ãã“ã§ä»Šå›ã€Playwright ã‚’å‚è€ƒã«ã—ã¦ã€Ruby ã§ãƒ–ãƒ©ã‚¦ã‚¶éŒ²ç”»æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚

## éŒ²ç”»ä¾‹

## ä½¿ç”¨ã—ã¦ã„ã‚‹ä¸»ãªæŠ€è¡“

### CDP ã‚’ç”¨ã„ãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ã‚¹ãƒˆ

CDPï¼ˆChrome DevTools Protocolï¼‰ã¯ã€Chromium ãƒ™ãƒ¼ã‚¹ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã™ã€‚ä»Šå›ã¯æ‰±ã†ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ Chrome ã«çµã£ã¦èª¬æ˜ã—ã¾ã™ã€‚

CDP ã‚’ä½¿ç”¨ã—ã¦ã€Chrome ã®ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®1ãƒ•ãƒ¬ãƒ¼ãƒ åˆ†ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆï¼‰ã‚’é€£ç¶šçš„ã«æ’®å½±ã—ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰ã¸é€ä¿¡ã—ã¾ã™ã€‚
å…·ä½“çš„ã«ã¯ã€CDP ã®ãƒ¡ã‚½ãƒƒãƒ‰ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¬¡ã®é †ã§å®Ÿè¡Œã—ã¾ã™ï¼š

1. [Page.startScreencast](https://chromedevtools.github.io/devtools-protocol/tot/Page/#method-startScreencast): ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ã‚¹ãƒˆï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ã®é€£ç¶šæ’®å½±ã¨é€ä¿¡ï¼‰ã‚’é–‹å§‹ã—ã¾ã™ã€‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦ã€ç”»åƒå½¢å¼ï¼ˆjpeg ã¾ãŸã¯ pngï¼‰ã€ç”»åƒå“è³ªï¼ˆ0..100ï¼‰ã€æœ€å¤§ã‚µã‚¤ã‚ºã€ãŠã‚ˆã³é€ä¿¡é »åº¦ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½•æšãŠãã«é€ä¿¡ã™ã‚‹ã‹ï¼‰ã‚’è¨­å®šã§ãã¾ã™ã€‚
2. [Page.screencastFrame](https://chromedevtools.github.io/devtools-protocol/tot/Page/#event-screencastFrame): Base64 ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒã€ãƒ•ãƒ¬ãƒ¼ãƒ å–å¾—æ—¥æ™‚ãªã©ã‚’ä¿æŒã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã§ã™ã€‚ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰ã«é€ä¿¡ã•ã‚Œã¾ã™ã€‚
3. [Page.screencastFrameAck](https://chromedevtools.github.io/devtools-protocol/tot/Page/#method-screencastFrameAck): å—ä¿¡å´ãŒã€Œ`Page.screencastFrame` ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ­£å¸¸ã«å—ã‘å–ã£ãŸã€ã¨ã„ã†å¿œç­”ã§ã™ã€‚ã“ã®å¿œç­”ãŒæ¥ãŸå¾Œã€Chrome ã¯æ¬¡ã® `Page.screencastFrame` ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã—ã¾ã™ã€‚ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ã‚¹ãƒˆã‚’åœæ­¢ã™ã‚‹ã¾ã§ã€2ã¨3ãŒç¹°ã‚Šè¿”ã•ã‚Œã¾ã™ã€‚

æœ€å¾Œã«ã€é©å½“ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ [Page.stopScreencast](https://chromedevtools.github.io/devtools-protocol/tot/Page/#method-stopScreencast) ã§ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ã‚¹ãƒˆã‚’åœæ­¢ã—ã¾ã™ã€‚

### FFmpeg ã‚’ç”¨ã„ãŸç”»åƒã‹ã‚‰å‹•ç”»ã¸ã®å¤‰æ›

[FFmpeg](https://ffmpeg.org/) ã¯ã€ä¸»ã«å‹•ç”»ã‚„éŸ³å£°ã®å¤‰æ›ã«ä½¿ç”¨ã•ã‚Œã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã§ã™ã€‚

FFmpeg ã‚’ä½¿ç”¨ã—ã¦ã€é€£ç¶šã™ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒã‚’å‹•ç”»ã¨ã—ã¦é€æ¬¡çš„ã«è¿½åŠ ã—ã¦ã„ãã“ã¨ã§ã€1ã¤ã®é€£ç¶šã—ãŸå‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€`-f image2pipe` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã„ã€ãƒ‘ã‚¤ãƒ—ã‚’é€šã˜ã¦å—ã‘å–ã£ãŸé€£ç¶šã™ã‚‹ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦å‡ºåŠ›ã—ã¾ã™ã€‚

ãã®ä»–ã®ç´°ã‹ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ãŸã¨ãˆã°è§£åƒåº¦ã‚„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆãªã©ã¯ã€[Playwright ã®è¨­å®š](https://github.com/microsoft/playwright/blob/release-1.44/packages/playwright-core/src/server/chromium/videoRecorder.ts#L101)ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚

## ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³

Chrome ã¨ CDP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆCDP ã‚’ä»‹ã—ã¦ Chrome ã¨é€šä¿¡ã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰ã€FFmpeg ã®ã‚„ã‚Šå–ã‚Šã‚’ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã§è¡¨ã™ã¨ã€æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```mermaid
sequenceDiagram
    participant FFmpeg
    participant client as CDP client
    participant Browser as Chrome

    client->>Browser: WebSocket ã§æ¥ç¶š

    client->>Browser: Page.startScreencast<br>ï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ã‚¹ãƒˆã®é–‹å§‹ï¼‰

    loop å—ä¿¡ã¨å¿œç­”ã®ãƒ«ãƒ¼ãƒ—
        Browser->>client: Page.screencastFrame<br>ï¼ˆ1ãƒ•ãƒ¬ãƒ¼ãƒ åˆ†ã®ç”»åƒãƒ‡ãƒ¼ã‚¿ï¼‰
        client->>FFmpeg: ç”»åƒãƒ‡ãƒ¼ã‚¿
        FFmpeg->>FFmpeg: å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
        client->>Browser: Page.screencastFrameAck<br>ï¼ˆç”»åƒãƒ‡ãƒ¼ã‚¿å—ä¿¡ã®å¿œç­”ï¼‰
    end

    client->>Browser: Page.stopScreencast<br>ï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ã‚¹ãƒˆã®åœæ­¢ï¼‰
```

## å®Ÿè£…ã—ãŸ Ruby ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

### å®Ÿè¡Œç’°å¢ƒ

- Ruby 3.3.0
- gem ã® chrome_remote^[`chrome_remote` ã¯ã™ã§ã«ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã•ã‚Œã¦ãŠã‚‰ãšã€README ã«ã€Œä»£ã‚ã‚Šã« Ferrum ã‚’ä½¿ã†ã¨ã‚ˆã„ã€ã¨ã„ã†è¨˜è¼‰ãŒã‚ã‚Šã¾ã™ã€‚ã—ã‹ã—ä»Šå›ã¯ã€Ferrum ã¯ `Page.startScreencast` ã®ã‚µãƒãƒ¼ãƒˆãŒãªã„ã“ã¨ã€ä»–ã«è©¦ã—ãŸ gem `websocket-client-simple` ã¯ç”»åƒãƒ‡ãƒ¼ã‚¿é€å—ä¿¡ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚°ãŒç™ºç”Ÿã—ã¦ã—ã¾ã†ã“ã¨ã‚’è¸ã¾ãˆã¦ã€`chrome_remote` ã‚’ä½¿ã†ã“ã¨ã¨ã—ã¾ã—ãŸ] 0.3.0
- FFmpeg 7.0
- Google Chrome 124.0.6367.79 (arm64)


Playwright ã® [`playwright-core/src/server/chromium/videoRecorder.ts`](https://github.com/microsoft/playwright/blob/release-1.44/packages/playwright-core/src/server/chromium/videoRecorder.ts) ã‚’å‚è€ƒã«ã—ã¤ã¤ã€æ¬¡ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã—ãŸã€‚

@[gist](https://gist.github.com/AudioStakes/50ed995cc2190b5facaadb92054e4507)

### ä½¿ã„æ–¹

äº‹å‰æº–å‚™ã¨ã—ã¦ã€Google Chrome ã‚’ `remote-debugging-port` ã‚’æœ‰åŠ¹ã«ã—ãŸçŠ¶æ…‹ã§èµ·å‹•ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
port ç•ªå·ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® 9222 ã§ã™ã€‚
macOS ã®å ´åˆã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§èµ·å‹•ã§ãã¾ã™ã€‚

```
$ /Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --remote-debugging-port=9222
```

Chrome ã‚’èµ·å‹•ã—ãŸå¾Œã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```
$ ruby chrome_screen_recorder.rb
Connecting to Chrome launched with --remote-debugging-port=9222 ... Connected.
Recording started. Press Ctrl+C to stop.
```

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œä¸­ã¯ Chrome ãŒéŒ²ç”»ã•ã‚Œç¶šã‘ã¾ã™ã€‚
Ctrl+C ã‚’æŠ¼ã™ã¨éŒ²ç”»ãŒçµ‚äº†ã•ã‚Œã€å‹•ç”»ãŒ WebM å½¢å¼ã§ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚WebM ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã§å†ç”Ÿã§ãã¾ã™ã€‚

### æ³¨æ„ç‚¹

`Page.screencastFrame` ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†ãŒãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆï¼ˆ25 fpsï¼‰ã‚’ä¸‹å›ã‚‹å ´åˆã€å®Ÿéš›ã®éŒ²ç”»æ™‚é–“ã‚ˆã‚ŠçŸ­ã„å‹•ç”»ãŒç”Ÿæˆã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€æ¬¡ã®ã‚ˆã†ã«ã€é…å»¶ã—ãŸå ´åˆã¯æœ€å¾Œã«å—ä¿¡ã—ãŸãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¤‡æ•°å›æ›¸ãè¾¼ã‚“ã§ã„ã¾ã™ã€‚

``` ruby
duration_sec = frame.timestamp - @last_frame.timestamp
repeat_count = [1, (duration_sec * FRAMES_PER_SECOND).to_i].max

repeat_count.times { @ffmpeg_io.write(@last_frame.data) }
```

ã“ã‚Œã«ã‚ˆã‚Šã€å‡ºåŠ›ã™ã‚‹å‹•ç”»ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆã‚’ç¶­æŒã—ã¦ã„ã¾ã™ã€‚

## ã¾ã¨ã‚

ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚

## å‚è€ƒè³‡æ–™
