---
title: "Capybara ã§ Chrome DevTools Protocol ã‚’ä½¿ã£ã¦ DOM èª­ã¿è¾¼ã¿å®Œäº†å‰ã« JavaScript ã‚’å®Ÿè¡Œã™ã‚‹"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["capybara", "cdp", "Selenium", "Rails"]
published: true
---

## ã¯ã˜ã‚ã«

ä¸€èˆ¬çš„ã«ã€Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€JavaScript ã¯ DOM ã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’ç¤ºã™ `DOMContentLoaded` ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«å¾Œã«å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¤šã„ã¨æ€ã„ã¾ã™ã€‚

ã—ã‹ã—ã€E2E ãƒ†ã‚¹ãƒˆã§ã¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ã—ã¦ã® JavaScript ã‚’ `DOMContentLoaded` ã‚ˆã‚Šå…ˆã«å®Ÿè¡Œã—ãŸã„å ´é¢ã‚‚ã‚ã‚Šã¾ã™ã€‚Capybara ã§ã¯ [`#execute_script`](https://www.rubydoc.info/gems/capybara/Capybara%2FSession:execute_script) ã§ JavaScript ã‚’å®Ÿè¡Œã§ãã¾ã™ãŒã€ã“ã®å ´åˆã¯ `DOMContentLoaded` ã®å¾Œã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ã“ã®èª²é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€ã“ã®è¨˜äº‹ã§ã¯ [Chrome DevTools Protocolï¼ˆCDPï¼‰](https://chromedevtools.github.io/devtools-protocol/)ã® `Page.addScriptToEvaluateOnNewDocument` ã‚’ä½¿ç”¨ã—ã¦ã€`DOMContentLoaded` ã‚ˆã‚Šå…ˆã« JavaScript ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## Chrome DevTools Protocolï¼ˆCDPï¼‰ã¨ã¯

Chrome DevTools Protocolï¼ˆCDPï¼‰ã¯ã€Google Chrome ç­‰ã® Chromium ãƒ™ãƒ¼ã‚¹ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã™ã€‚
CDP ã‚’ä½¿ã†ã“ã¨ã§ã€Chrome ãƒ–ãƒ©ã‚¦ã‚¶ã® Developer Tools ã§å¯èƒ½ãªæ“ä½œã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

CDP ã¯ [Playwright](https://github.com/microsoft/playwright) ã‚„ [Puppeteer](https://github.com/puppeteer/puppeteer) ãªã©ã€[æ•°å¤šãã®ãƒ„ãƒ¼ãƒ«ã§ä½¿ã‚ã‚Œã¦ã„ã¾ã™](https://github.com/ChromeDevTools/awesome-chrome-devtools?tab=readme-ov-file#chrome-devtools-protocol)ã€‚Ruby æ–¹é¢ã§ã¯ã€Capybara ã®ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã§ã‚ã‚‹ [Cuprite](https://github.com/rubycdp/cuprite) ã§ã€CDP ã«åŸºã¥ã„ã¦å‹•ä½œã™ã‚‹ [Ferrum](https://github.com/rubycdp/ferrum) ãŒä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚
â€» ä»Šå›ã¯ Rails 7.1 ã§ Capybara ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã§ã‚ã‚‹ Selenium WebDriver ã‚’ä½¿ã£ãŸæ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## `Page.addScriptToEvaluateOnNewDocument` ã¨ã¯

[`Page.addScriptToEvaluateOnNewDocument`](https://chromedevtools.github.io/devtools-protocol/tot/Page/#method-addScriptToEvaluateOnNewDocument) ã¯ CDP ãŒæä¾›ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã®1ã¤ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒæ–°ã—ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚€å‰ã€ã¤ã¾ã‚Š DOM ãŒæ§‹ç¯‰ã•ã‚Œã‚‹ã‚ˆã‚Šã‚‚å‰ã«ã€æŒ‡å®šã—ãŸ JavaScript ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã“ã¨ã§ã€`DOMContentLoaded` ã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºç«å‰ã«ä»»æ„ã® JavaScript ãŒå®Ÿè¡Œå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

## Capybara ã§ CDP ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•

[Selenium WebDriver](https://github.com/SeleniumHQ/selenium) ã« CDP ã‚’å®Ÿè¡Œã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ `#execute_cdp` ãŒã‚ã‚‹ãŸã‚ã€Capybara ã®ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¨ã—ã¦ Selenium WebDriver ã‚’ä½¿ã†ã“ã¨ã§ã€é–“æ¥çš„ã« CDP ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ãªãŠã€ãƒ–ãƒ©ã‚¦ã‚¶ã¨ã—ã¦ CDP ãŒå®Ÿè¡Œå¯èƒ½ãªã‚‚ã®ï¼ˆChrome ç­‰ï¼‰ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ä½¿ç”¨ä¾‹

æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã¯ã€Capybara ã¨ Selenium WebDriver ã‚’çµ„ã¿åˆã‚ã›ã¦ `Page.addScriptToEvaluateOnNewDocument` ã‚’ä½¿ã„ã€ä»¥ä¸‹ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ `console.log` ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã® JavaScript ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚

- `Page.addScriptToEvaluateOnNewDocument` ã§è¿½åŠ ã•ã‚ŒãŸ JavaScript ã®å®Ÿè¡Œæ™‚
- `DOMContentLoaded` ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«æ™‚

ãªãŠã€æ¯”è¼ƒç”¨ã«ã€ `Capybara.visit` ã®å‰å¾Œã§ `Capybara.execute_script` ã§ `console.log` ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

```ruby
require 'bundler/inline'

gemfile do
  source 'https://rubygems.org'
  gem 'capybara', require: 'capybara/dsl' # è¨˜äº‹åŸ·ç­†æ™‚ç‚¹ã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 3.40.0 ã‚’ä½¿ç”¨
  gem 'selenium-webdriver' # åŒæ§˜ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 4.19.0 ã‚’ä½¿ç”¨
end

# driver ã¨ã—ã¦ Seleniumã€ãƒ–ãƒ©ã‚¦ã‚¶ ã¨ã—ã¦ Chrome ã‚’æŒ‡å®š
Capybara.current_driver = :selenium_chrome

chrome_driver = Capybara.page.driver.browser
# => #<Selenium::WebDriver::Chrome::Driver:0x7f8a9cc561d591d8 browser=:chrome>

# CDP ã® Page.addScriptToEvaluateOnNewDocument ã‚’ä½¿ã£ã¦ console ã«ãƒ­ã‚°å‡ºåŠ›ã™ã‚‹ JavaScript ã‚’è¿½åŠ 
chrome_driver.execute_cdp('Page.addScriptToEvaluateOnNewDocument', source: <<~JavaScript)
  console.log('Page.addScriptToEvaluateOnNewDocument ã§è¿½åŠ ã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆ')
  document.addEventListener('DOMContentLoaded', () => console.log('DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«'))
JavaScript

# æ¤œè¨¼ã®ãŸã‚ã€visit å‰å¾Œã« execute_script ã§ console ã«ãƒ­ã‚°ã‚’å‡ºåŠ›
Capybara.execute_script('console.log("Capybara.visit å‰ã® Capybara.execute_script")')
Capybara.visit 'https://example.com/'
Capybara.execute_script('console.log("Capybara.visit å¾Œã® Capybara.execute_script")')

# Chrome ã® console ã«å‡ºåŠ›ã•ã‚ŒãŸãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®å¾…æ©Ÿæ™‚é–“
sleep 10
```

### å®Ÿè¡Œçµæœ

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ Chrome ã® console ã‚’ç¢ºèªã™ã‚‹ã¨ã€ä»¥ä¸‹ã®é †ã§ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™ã€‚

```
Page.addScriptToEvaluateOnNewDocument ã§è¿½åŠ ã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆ
DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
Capybara.visit å¾Œã® Capybara.execute_script
```

ã“ã®çµæœã‹ã‚‰ã€`Page.addScriptToEvaluateOnNewDocument` ã§è¿½åŠ ã—ãŸ JavaScript ã¯ãŸã—ã‹ã« `DOMContentLoaded` ã‚ˆã‚Šå…ˆã«å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

## E2E ãƒ†ã‚¹ãƒˆã§ `Page.addScriptToEvaluateOnNewDocument` ã‚’ä½¿ã†éš›ã®æ³¨æ„ç‚¹

`Page.addScriptToEvaluateOnNewDocument` ã§è¿½åŠ ã•ã‚ŒãŸ JavaScript ã¯ã€ãã®å¾Œã®ãƒ†ã‚¹ãƒˆã§ã‚‚å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€å¾Œå‡¦ç†ã¨ã—ã¦ `Page.removeScriptToEvaluateOnNewDocument` ã§å‰Šé™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä»¥ä¸‹ã¯ã€Rails 7.1 ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚ã‚‹ Minitest ã‚’ä½¿ã£ãŸ E2E ãƒ†ã‚¹ãƒˆï¼ˆã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆï¼‰ã§ã®ä¾‹ã§ã™ã€‚

```ruby
class UsersTest < ApplicationSystemTestCase
  setup do
    @script_id = Capybara.page.driver.browser.execute_cdp('Page.addScriptToEvaluateOnNewDocument', source: 'console.log("hoge")')
  end

  teardown do
    if defined?(@script_id)
      Capybara.page.driver.browser.execute_cdp('Page.removeScriptToEvaluateOnNewDocument', **@script_id)
    end
  end

  ...
```

## ã¾ã¨ã‚

Capybara ã¨ Selenium WebDriver ã‚’çµ„ã¿åˆã‚ã›ã¦ CDP ã® `Page.addScriptToEvaluateOnNewDocument` ã‚’ä½¿ã„ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿å‰ã€ã™ãªã‚ã¡ `DOMContentLoaded` ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«å‰ã« JavaScript ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚

ã“ã®æŠ€è¡“ã¯ã€è‡ªå‹•ãƒ†ã‚¹ãƒˆã«ãŠã„ã¦ JavaScript ã§æ‰±ã†ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¢ãƒƒã‚¯ã—ãŸã„å ´åˆã‚„ã€ãƒšãƒ¼ã‚¸ã®åˆæœŸçŠ¶æ…‹ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸã„å ´åˆã«æ´»ç”¨ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

CDPã«ã¯ä»–ã«ã‚‚ã•ã¾ã–ã¾ãªæ©Ÿèƒ½ãŒã‚ã‚Šã€ Chrome ã® Developer Tools ã‚’ä½¿ã£ãŸæ“ä½œãŒè‡ªå‹•ãƒ†ã‚¹ãƒˆã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚[CDP ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://chromedevtools.github.io/devtools-protocol/)ã«ç›®ã‚’é€šã™ã¨ã€å½¹ç«‹ã¤ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
